unit puhekup7;interfaceuses  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,  ExtCtrls, StdCtrls;type TDirection = (pleft,pright,pup,pdown);type TAlignment = (aleft,acenter,aright);type TCurveparam = class;     TMouthparam = class;     Tkupla = class(TGraphicControl)  private    { Laskettavat piirtoparametrit }    pidakuplamuoto,alku : Boolean;    taytetaan, harjaon : Boolean;    onvaritekstialue : Boolean;    onreuna : Boolean;    vari,tekstialuevari : TColor;    varitekstialuealkurivi,    varitekstialuealkusarake,    varitekstialueloppurivi,    varitekstialueloppusarake : integer;    leveys,korkeus : integer;    leftk,topk : integer;    piste1x,piste1y,piste2x,piste2y : integer;    osakaarenpala1,osakaarenpala2 : integer;    { Asetettavat parametrit }    curveparam : TCurveparam;    mouthparam : TMouthparam;    viivanpaksuus : integer;    tayttovari,reunusvari : TColor;    fontti : TFont;    textpaikkax,textpaikkay : integer;    textleveys,textkorkeus : integer;    teksti : TStringList;    onteksti,onkuva : Boolean;    kuva : TPicture;    kuvapaikkax,kuvapaikkay : integer;    kuvaleveys,kuvakorkeus : integer;    rivivali : integer;    tasaus : TAlignment;    procedure tekstimuutettu( Sender : TObject );    procedure maaritavasensuuoskaaret;    procedure maaritaoikeasuuoskaaret;    procedure maaritaalasuuoskaaret;    procedure maaritaylasuuoskaaret;    procedure maaritakaaret;    procedure maaritareunat;    procedure maaritaparametrit;    function tarkistasuuaukko : Boolean;    function tarkistakaaret: Boolean;    procedure laskesuhtparam( var spiste1x,spiste1y,spiste2x,spiste2y :      integer );    procedure haeparam( var p,np,merkki : integer ; x : Boolean );    function tarkistasuuosa: Boolean;    function tarkistasuorakaide( rx,ry,rleveys,rkorkeus : integer )      : Boolean;    function maar_ja_tarkistaparametrit : Boolean;    function tarkistavaritekstialue : Boolean;        procedure piirraosakaaret1;    procedure piirraosakaaret2;    procedure piirraosakaaret3;    procedure piirraosakaaret4;    procedure piirrakaaret;    procedure piirraosaviivat;    procedure piirrataydetviivat;    procedure piirraviivat;    procedure piirravasensuuosa;    procedure piirraoikeasuuosa;    procedure piirraalasuuosa;    procedure piirraylasuuosa;    procedure piirrasuuosa;    function sopivamj( const mj :string ; var muuttui : Boolean ;      var rleveys : integer ) : string;    function skaalaax( kerroin : double ) : Boolean;    function skaalaay( kerroin : double ) : Boolean;    procedure piirratekstirivi( xpaikka, ypaikka, rivi : integer ;      mj : string );    procedure piirrateksti;    procedure taytasisus;    procedure SetFillOn( Value : Boolean );    procedure SetBrushOn( Value : Boolean );    procedure SetColoredTextAreaOn( Value : Boolean );    procedure SetColoredTextAreaColor( Value : TColor );    procedure SetColoredTextAreaBeginRow( Value : integer );    procedure SetColoredTextAreaBeginCol( Value : integer );    procedure SetColoredTextAreaEndRow( Value : integer );    procedure SetColoredTextAreaEndCol( Value : integer );    procedure SetKeepBubbleForm( Value : Boolean );    procedure SetMouthParam( Value : TMouthParam );    procedure SetCurveParam( Value : TCurveParam );    procedure SetText( const Value : TStringList );    procedure SetTextOn( Value : Boolean );    procedure SetPicture( Value : TPicture );    procedure SetPicturex( Value : integer );    procedure SetPicturey( Value : integer );    procedure SetPictureWidth( Value : integer );    procedure SetPictureHeight( Value : integer );    procedure SetPictureOn( Value : Boolean );    procedure SetFont( Value : TFont );    procedure SetLineCap( Value : integer );    procedure SetTextBeginX( Value : integer );    procedure SetTextBeginY( Value : integer );    procedure SetTextAreaWidth( Value : integer );    procedure SetTextAreaHeight( Value : integer );    procedure SetAlignment( Value : TAlignment );    procedure SetBorderOn( Value : Boolean );    procedure SetBorderWidth( Value : integer );    procedure SetFillColor( Value : TColor );    procedure SetBorderColor( Value : TColor );    procedure SetBounds(ALeft, ATop, AWidth, AHeight: Integer);override;  protected    procedure Paint; override;  public    constructor Create( AOwner : TComponent ); override;    destructor Destroy; override;  published    property Align;    property DragCursor;    property DragMode;    property Enabled;    property ParentShowHint;    property KeepBubbleForm : Boolean read pidakuplamuoto write      SetKeepBubbleForm;    property Alignment : TAlignment read tasaus write SetAlignment;    property MouthPart : Tmouthparam read mouthparam      write SetMouthParam;    property CurvePart : TCurveparam read curveparam      write SetCurveParam;    property Text : TStringList read teksti write SetText;    property TextOn : Boolean read onteksti write SetTextOn;    property Font : TFont read fontti write SetFont;    property LineCap : integer read rivivali write SetLineCap;    property BorderOn : Boolean read onreuna write      SetBorderOn;    property BorderWidth : integer read viivanpaksuus write SetBorderWidth;    property TextBeginX : integer read textpaikkax write SetTextBeginx;    property TextBeginY : integer read textpaikkay write SetTextBeginy;    property TextAreaWidth : integer read textleveys write      SetTextAreaWidth;    property TextAreaHeight : integer read textkorkeus write      SetTextAreaHeight;    property FillColor : TColor read tayttovari write      SetFillColor;    property FillOn : Boolean read taytetaan write      SetFillOn;    property BrushOn : Boolean read harjaon write      SetBrushOn;    property BorderColor : TColor read reunusvari write      SetBorderColor;    property Picture : TPicture read kuva write SetPicture;    property PictureX : integer      read kuvapaikkax write SetPicturex;    property PictureY : integer      read kuvapaikkay write SetPicturey;    property PictureWidth  : integer read kuvaleveys  write SetPictureWidth;    property PictureHeight : integer read kuvakorkeus write SetPictureHeight;    property PictureOn : Boolean     read onkuva      write SetPictureOn;    property ColoredTextAreaOn : Boolean read onvaritekstialue      write SetColoredTextAreaOn;    property ColoredTextAreaColor : TColor read tekstialuevari      write SetColoredTextAreaColor;    property ColoredTextAreaBeginRow : integer      read varitekstialuealkurivi write SetColoredTextAreaBeginRow;    property ColoredTextAreaBeginCol : integer      read varitekstialuealkusarake write SetColoredTextAreaBeginCol;    property ColoredTextAreaEndRow : integer      read varitekstialueloppurivi write SetColoredTextAreaEndRow;    property ColoredTextAreaEndCol : integer      read varitekstialueloppusarake write SetColoredTextAreaEndCol;    property Visible;    property OnDragDrop;    property OnDragOver;    property OnEndDrag;    property OnMouseDown;    property OnMouseMove;    property OnMouseUp;    property OnStartDrag;end;  TMouthparam = class(TPersistent)    private    kupla : Tkupla;    pidasuunmuoto : Boolean;    suunsuunta, suuosansuunta : TDirection;    suunpaikka,suunpaikanleveys : integer;    suuosankarki,suuosanpuolenvenp,    suuosanvastapvenp : TPoint;    function skaalaax( kerroin : double ) : Boolean;    function skaalaay( kerroin : double ) : Boolean;    procedure vaihdareunakoord( var koord : integer );    procedure vaihdareuna( suuossuunta : TDirection );    procedure vaihdaxmerkit;    procedure vaihdaymerkit;    procedure vaihdamerkit( vanhasuuossuunta, uusisuuossuunta : TDirection );    procedure vaihdaxy;    procedure vaihdaxytarpeessa( vanhasuuossuunta,uusisuuossuunta :      TDirection );    procedure vaihdavastsuunsuunta( vanhasuuossuunta,uusisuuossuunta :      TDirection );    procedure SetBeginValues;    procedure SetKeepMouthForm( Value : Boolean );    procedure SetMouthPlace( Value : integer );    procedure SetMouthPlaceWidth( Value : integer );    procedure SetMouthPartDirection( Value : TDirection );    procedure SetMouthDirection( Value : TDirection );    procedure SetMouthOutX( Value : integer );    procedure SetMouthOutY( Value : integer );    procedure SetMouthSideFormPx( Value : integer );    procedure SetMouthSideFormPy( Value : integer );    procedure SetNotMouthSideFormPx( Value : integer );    procedure SetNotMouthSideFormPy( Value : integer );  published    property KeepMouthForm : Boolean read pidasuunmuoto write      SetKeepMouthForm;    property MouthPartDirection : TDirection read suuosansuunta write      SetMouthPartDirection;    property MouthDirection : TDirection read suunsuunta write      SetMouthDirection;    property MouthPlace : integer read suunpaikka write SetMouthPlace;    property MouthPlaceWidth : integer read suunpaikanleveys      write SetMouthPlaceWidth;    property MouthOutY : integer read suuosankarki.y      write SetMouthOutY;    property MouthOutX : integer read suuosankarki.x      write SetMouthOutX;    property MouthSideFormPx : integer read suuosanpuolenvenp.x      write SetMouthSideFormPx;    property MouthSideFormPy : integer read suuosanpuolenvenp.y      write SetMouthSideFormPy;    property NotMouthSideFormPx : integer read suuosanvastapvenp.x      write SetNotMouthSideFormPx;    property NotMouthSideFormPy : integer read suuosanvastapvenp.y      write SetNotMouthSideFormPy;end;  TCurveparam = class(TPersistent)    private    kupla : Tkupla;    vasenalakaarikorkeus,    vasenalakaarileveys,    oikeaalakaarikorkeus,    oikeaalakaarileveys,    vasenylakaarikorkeus,    vasenylakaarileveys,    oikeaylakaarikorkeus,    oikeaylakaarileveys : integer;    procedure SetBeginValues;    function skaalaax( kerroin : double ) : Boolean;    function skaalaay( kerroin : double ) : Boolean;    procedure SetLowerLeftCurveWidth( Value : integer );    procedure SetUpperLeftCurveWidth( Value : integer );    procedure SetLowerRightCurveWidth( Value : integer );    procedure SetUpperRightCurveWidth( Value : integer );    procedure SetLowerLeftCurveHeight( Value : integer );    procedure SetUpperLeftCurveHeight( Value : integer );    procedure SetLowerRightCurveHeight( Value : integer );    procedure SetUpperRightCurveHeight( Value : integer );  published    property LowerLeftCurveHeight  : integer  read vasenalakaarikorkeus       write SetLowerLeftCurveHeight;    property LowerLeftCurveWidth   : integer  read vasenalakaarileveys       write SetLowerLeftCurveWidth;    property UpperLeftCurveHeight  : integer  read vasenylakaarikorkeus       write SetUpperLeftCurveHeight;    property UpperLeftCurveWidth   : integer  read vasenylakaarileveys       write SetUpperLeftCurveWidth;    property LowerRightCurveHeight : integer read oikeaalakaarikorkeus       write SetLowerRightCurveHeight;    property LowerRightCurveWidth  : integer read oikeaalakaarileveys       write SetLowerRightCurveWidth;    property UpperRightCurveHeight : integer  read oikeaylakaarikorkeus       write SetUpperRightCurveHeight;    property UpperRightCurveWidth  : integer  read oikeaylakaarileveys       write SetUpperRightCurveWidth;end;procedure register;implementation{ TMouthParam }{ MouthParam toimii sill… periaatteella, ett… se asettaa muutettavan  parametrin vara-muuttujaan, sijoittaa sen paikalle uuden arvon,  kutsuu kuplan maar_ja_tarkistaparametrit -ohjelmaa. T…m…n  j…lkeen parametreja muuttava ohjelma, antaa piirtok…skyn  kuplalle ( InValidate ), mik…li parametrit kelpasivat, ja  jos ne eiv…t kelvanneet asetetaan vanha arvo takaisin  parametrin paikalle ja kutsutaan kuplan maaritaparametrit -  ohjelmaa, joka laskee kuplan piirtoparametrit takaisin  vanhoille kelpoparametrin arvoille.  }procedure TMouthParam.SetKeepMouthForm( Value : Boolean );begin  pidasuunmuoto := Value;end;function TMouthParam.skaalaax( kerroin : double ) : Boolean;var usuunpaikanleveys,usuuosankarki,usuunpp,ueisuunpp : integer;begin  result := true;  if (kerroin>0) then begin    if (suuosansuunta=pup) or (suuosansuunta=pdown) then      usuunpaikanleveys := round(kerroin*suunpaikanleveys);    usuuosankarki := round(kerroin*suuosankarki.x);    usuunpp := round(kerroin*suuosanpuolenvenp.x);    ueisuunpp := round(kerroin*suuosanvastapvenp.x);    if (usuunpaikanleveys>0) and (usuuosankarki>0)      and (usuunpp>0) and (ueisuunpp>0) then begin      suunpaikanleveys := usuunpaikanleveys;      suuosankarki.x := usuuosankarki;      suuosanpuolenvenp.x := usuunpp;      suuosanvastapvenp.x := ueisuunpp;    end else result := false;  end else result := false;end;function TMouthParam.skaalaay( kerroin : double ) : Boolean;var usuunpaikanleveys,usuuosankarki,usuunpp,ueisuunpp : integer;begin  result := true;  if (kerroin>0) then begin    if (suuosansuunta=pleft) or (suuosansuunta=pright) then      usuunpaikanleveys := round(kerroin*suunpaikanleveys);    usuuosankarki := round(kerroin*suuosankarki.y);    usuunpp := round(kerroin*suuosanpuolenvenp.y);    ueisuunpp := round(kerroin*suuosanvastapvenp.y);    if (usuunpaikanleveys>0) and (usuuosankarki>0)      and (usuunpp>0) and (ueisuunpp>0) then begin      suunpaikanleveys := usuunpaikanleveys;      suuosankarki.y := usuuosankarki;      suuosanpuolenvenp.y := usuunpp;      suuosanvastapvenp.y := ueisuunpp;    end else result := false;  end else result := false;end;procedure TMouthParam.SetBeginValues;begin  pidasuunmuoto := true;  suunsuunta := pup         ; suuosansuunta := pleft   ;  suunpaikka := 20          ; suunpaikanleveys := 20   ;  suuosankarki.x  := -25    ; suuosankarki.y := 7      ;  suuosanpuolenvenp.x := -10; suuosanpuolenvenp.y := 10;  suuosanvastapvenp.x := -13; suuosanvastapvenp.y := 17;end;procedure TMouthParam.SetMouthPlace( Value : integer );var ok : Boolean;    vara : integer;begin  vara := suunpaikka;  suunpaikka := Value;  ok := kupla.maar_ja_tarkistaparametrit;  if (ok) then kupla.Invalidate else    begin    suunpaikka := vara;    kupla.maaritaparametrit;    end;end;procedure TMouthParam.SetMouthPlaceWidth( Value : integer );{ Ohjelma muuttaa suunpaikanleveyden, mik…li se skaalauksen p……ll…ollessa  on sallittua ( muutos-muuttuja ). }var ok,muutos : Boolean;    vara : integer;begin  vara := suunpaikanleveys;muutos := true;ok := true;  if pidasuunmuoto then begin    case suuosansuunta of      pleft,pright : muutos := skaalaay( Value/vara );      pup,pdown    : muutos := skaalaax( Value/vara );    end;  end else suunpaikanleveys := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if (ok and muutos) then kupla.Invalidate else    begin    if pidasuunmuoto and muutos then begin      case suuosansuunta of      pleft,pright : skaalaay( vara/Value );      pup,pdown    : skaalaax( vara/Value );      end;    end else suunpaikanleveys := vara;    if muutos then kupla.maaritaparametrit;    end;end;procedure TMouthparam.vaihdareunakoord( var koord : integer );{ Vaihdetaan suunsuunnan vaihtoon liittyen suuosan pisteen  asema suunpaikan suhteen. }begin  koord := suunpaikanleveys - koord;end;procedure Tmouthparam.vaihdareuna( suuossuunta : TDirection );{ Vaihdetaan suunsuunnan vaihtoon liittyen suuosan pisteiden  asema suunpaikan suhteen. Parametri suuossuunta ilmaisee, mik…  on suuosansuunta, jonka oletetaan olevan voimassa, kun reunanvaihto  tehd……n. }begin  case suuossuunta of    pleft, pright : begin                    vaihdareunakoord( suuosanpuolenvenp.y );                    vaihdareunakoord( suuosanvastapvenp.y );                    vaihdareunakoord( suuosankarki.y );                    end;    pup,pdown :     begin                    vaihdareunakoord( suuosanpuolenvenp.x );                    vaihdareunakoord( suuosanvastapvenp.x );                    vaihdareunakoord( suuosankarki.x );                    end;  end;end;procedure TMouthParam.SetMouthDirection( Value : TDirection );{ Ohjelma suorittaa suunsuunnan vaihdon, mik…li se on sallittua.  Ohjelma suorittaa tarkistuksen sen suhteen, onko se suunnan puolesta  suhteessa suuosan suuntaan n…hden sallittua ja j…tt…… muut  tarkistukset kuplan maar_ja_tarkistaparametrit -ohjelmalle. }var ok : Boolean;    vara : TDirection;begin  if ((Value=pleft) and (suunsuunta=pright)) or     ((Value=pright) and (suunsuunta=pleft)) or     ((Value=pup) and (suunsuunta=pdown)) or     ((Value=pdown) and (suunsuunta=pup)) then begin  { suunsuunnan vaihto sallittua suuosan suuntaan n…hden }  vara := suunsuunta;  suunsuunta := Value;  vaihdareuna( suuosansuunta ); { suunsuunnan k…yt…nn˚n toteutus }  ok := kupla.maar_ja_tarkistaparametrit;  if (ok) then kupla.Invalidate else    begin    suunsuunta := vara;    vaihdareuna( suuosansuunta );    kupla.maaritaparametrit;    end;  end;end;procedure TMouthParam.vaihdaxmerkit;{ Vaihtaa suuosan pisteiden x-koordinaattien merkit lukuunottamatta  tietenkin suuosanpaikkaa ja sen leveytt…. }begin  suuosankarki.x := -suuosankarki.x;  suuosanpuolenvenp.x := -suuosanpuolenvenp.x;  suuosanvastapvenp.x := -suuosanvastapvenp.x;end;procedure TMouthParam.vaihdaymerkit;{ Vaihtaa suuosan pisteiden y-koordinaattien merkit lukuunottamatta  tietenkin suuosanpaikkaa ja sen leveytt…. }begin  suuosankarki.y := -suuosankarki.y;  suuosanpuolenvenp.y := -suuosanpuolenvenp.y;  suuosanvastapvenp.y := -suuosanvastapvenp.y;end;procedure TMouthParam.vaihdamerkit( vanhasuuossuunta,  uusisuuossuunta : TDirection );{ Vaihtaa suuosan pisteiden x- ja y-koordinaattien merkit  suuosansuunnan vaihtoon liittyen, jos tarvitaan.  Parametri vanhasuuossuunta kertoo, mik… on l…ht˚tilanteen  suuosansuunta ja toinen parametri uusisuuossuunta sen,  mik… on lopputilanteen suuosansuunta. }begin  case uusisuuossuunta of    pleft,pup :   case vanhasuuossuunta of                     pleft,pup : ;                     pright : vaihdaxmerkit;                     pdown : vaihdaymerkit;                  end;    pdown,pright: case vanhasuuossuunta of                     pdown,pright : ;                     pleft : vaihdaxmerkit;                     pup : vaihdaymerkit;                  end;  end;end;procedure vaihda( var m1,m2 : integer );{ Vaihtaa muuttujien arvot kesken……n. }var vaihto : integer;begin  vaihto := m1;  m1 := m2;  m2 := vaihto;end;procedure TMouthParam.vaihdaxy;{ Vaihtaa suuosan pisteiden x- ja y-koordinaatit kesken……n. }begin  vaihda( suuosankarki.x , suuosankarki.y );  vaihda( suuosanpuolenvenp.x, suuosanpuolenvenp.y );  vaihda( suuosanvastapvenp.x, suuosanvastapvenp.y );end;procedure TMouthParam.vaihdaxytarpeessa(  vanhasuuossuunta,uusisuuossuunta : TDirection );{ Vaihtaa suuosan pisteiden x- ja y-koordinaatit sen mukaan,  mik…li suuosan suunnan muutos sit… edellytt…….  Parametri vanhasuuossuunta ilmoittaa l…ht˚tilanteen  suuosansuunnan ja toinen parametri uusisuuossuunta  lopputilanteen suuosansuunnnan. }begin  case vanhasuuossuunta of    pleft,pright :      if (uusisuuossuunta=pup) or (uusisuuossuunta=pdown)        then vaihdaxy;    pup,pdown :      if (uusisuuossuunta=pleft) or (uusisuuossuunta=pright)        then vaihdaxy;  end;end;procedure TMouthParam.vaihdavastsuunsuunta( vanhasuuossuunta, uusisuuossuunta :  TDirection );{ Vaihtaa suunsuunnan sen mukaiseksi, mik… on suuosan suunnan muutos.  Parametri vanhasuuossuunta ilmoittaa l…ht˚tilanteen  suuosansuunnan ja toinen parametri uusisuuossuunta  lopputilanteen suuosansuunnnan. }var oldvastpaivaan : integer; { suunsuunta laitetaan samaan   kiertosuuntaan kuin vanhassa }    lahtopienilaita,kohdepienilaita : Boolean;     { Onko suuosanpuolella pienet vai isot numerot }begin  oldvastpaivaan := 1;lahtopienilaita := false;  case vanhasuuossuunta of    pleft : if (suunsuunta=pup) then      begin oldvastpaivaan := -1; lahtopienilaita := true; end;    pdown : if (suunsuunta=pleft) then      begin oldvastpaivaan := -1; lahtopienilaita := true; end;    pright : if (suunsuunta=pdown) then oldvastpaivaan := -1      else lahtopienilaita := true;    pup : if (suunsuunta=pright) then oldvastpaivaan := -1      else lahtopienilaita := true;  end;  kohdepienilaita := false;  case uusisuuossuunta of    pleft : if (oldvastpaivaan=1) then suunsuunta := pdown        else begin suunsuunta := pup;kohdepienilaita := true; end;    pdown : if (oldvastpaivaan=1) then suunsuunta := pright      else begin suunsuunta := pleft;kohdepienilaita := true; end;    pright : if (oldvastpaivaan=1) then      begin suunsuunta := pup; kohdepienilaita := true; end      else suunsuunta := pdown;    pup : if (oldvastpaivaan=1) then      begin suunsuunta := pleft;kohdepienilaita := true; end      else suunsuunta := pright;  end;  if not (kohdepienilaita=lahtopienilaita) then vaihdareuna( uusisuuossuunta );end;procedure TMouthParam.SetMouthPartDirection( Value : TDirection );{ Asettaa suuosansuunnan, mik…li se on muihin parametreihin n…hden sallittua.  Samalla korjataan suunsuunta siihen suuntaan, mik… on  vastap…iv……n vastaavassa suunnassa kuin vanha suunsuunta  oli suhteessa vanhaan suuosan suuntaan. }var ok : Boolean;    varasuuossuunta : TDirection;begin  varasuuossuunta := suuosansuunta;  suuosansuunta := Value;  vaihdamerkit( varasuuossuunta, suuosansuunta );  vaihdaxytarpeessa( varasuuossuunta, suuosansuunta );  vaihdavastsuunsuunta( varasuuossuunta, suuosansuunta );  ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else    begin    vaihdamerkit( suuosansuunta, varasuuossuunta );    vaihdaxytarpeessa( suuosansuunta, varasuuossuunta );    vaihdavastsuunsuunta( suuosansuunta, varasuuossuunta );    suuosansuunta := varasuuossuunta;    kupla.maaritaparametrit;    end;end;procedure TMouthParam.SetMouthOutX( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := suuosankarki.x;ok := true;muutos := true;  if (pidasuunmuoto) then    muutos := skaalaax( Value/vara )  else suuosankarki.x := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else { muutos=false -> invalidate }    begin    if pidasuunmuoto then      skaalaax( vara/Value )    else suuosankarki.x := vara;    kupla.maaritaparametrit;    end;end;procedure TMouthParam.SetMouthOutY( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := suuosankarki.y;ok := true;muutos := true;  if (pidasuunmuoto) then    muutos := skaalaay( Value/vara )  else suuosankarki.y := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else { muutos=false -> invalidate }    begin    if pidasuunmuoto then      skaalaay( vara/Value )    else suuosankarki.y := vara;    kupla.maaritaparametrit;    end;end;procedure TMouthParam.SetMouthSideFormPx( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := suuosanpuolenvenp.x;ok := true;muutos := true;  if (pidasuunmuoto) then    muutos := skaalaax( Value/vara )  else suuosanpuolenvenp.x := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else { muutos=false -> invalidate }    begin    if pidasuunmuoto then      skaalaax( vara/Value )    else suuosanpuolenvenp.x := vara;    kupla.maaritaparametrit;    end;end;procedure TMouthParam.SetMouthSideFormPy( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := suuosanpuolenvenp.y;ok := true;muutos := true;  if (pidasuunmuoto) then    muutos := skaalaay( Value/vara )  else suuosanpuolenvenp.y := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else { muutos=false -> invalidate }    begin    if pidasuunmuoto then      skaalaay( vara/Value )    else suuosanpuolenvenp.y := vara;    kupla.maaritaparametrit;    end;end;procedure TMouthParam.SetNotMouthSideFormPx( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := suuosanvastapvenp.x;ok := true;muutos := true;  if (pidasuunmuoto) then    muutos := skaalaax( Value/vara )  else suuosanvastapvenp.x := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else { muutos=false -> invalidate }    begin    if pidasuunmuoto then      skaalaax( vara/Value )    else suuosanvastapvenp.x := vara;    kupla.maaritaparametrit;    end;end;procedure TMouthParam.SetNotMouthSideFormPy( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := suuosanvastapvenp.y;ok := true;muutos := true;  if (pidasuunmuoto) then    muutos := skaalaay( Value/vara )  else suuosanvastapvenp.y := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else { muutos=false -> invalidate }    begin    if (pidasuunmuoto) then      skaalaay( vara/Value )    else suuosanvastapvenp.y := vara;    kupla.maaritaparametrit;    end;end;{ TCurveParam }procedure TCurveParam.SetBeginValues;begin  vasenalakaarileveys := 10;vasenalakaarikorkeus := 10;  vasenylakaarileveys := 10;vasenylakaarikorkeus := 10;  oikeaalakaarileveys := 10;oikeaalakaarikorkeus := 10;  oikeaylakaarileveys := 10;oikeaylakaarikorkeus := 10;end;function TCurveParam.skaalaax( kerroin : double ) : Boolean;var va,vy,oa,oy : integer;begin  result := true;  if (kerroin>0) then begin    va := round(kerroin*vasenalakaarileveys);    vy := round(kerroin*vasenylakaarileveys);    oa := round(kerroin*oikeaalakaarileveys);    oy := round(kerroin*oikeaylakaarileveys);    if (va>0) and (vy>0) and (oa>0) and (oy>0) then      begin      vasenalakaarileveys := va;      vasenylakaarileveys := vy;      oikeaalakaarileveys := oa;      oikeaylakaarileveys := oy;      end;  end else result := false;end;function TCurveParam.skaalaay( kerroin : double ) : Boolean;var va,vy,oa,oy : integer;begin  result := true;  if (kerroin>0) then begin    va := round(kerroin*vasenalakaarikorkeus);    vy := round(kerroin*vasenylakaarikorkeus);    oa := round(kerroin*oikeaalakaarikorkeus);    oy := round(kerroin*oikeaylakaarikorkeus);    if (va>0) and (vy>0) and (oa>0) and (oy>0) then      begin      vasenalakaarikorkeus := va;      vasenylakaarikorkeus := vy;      oikeaalakaarikorkeus := oa;      oikeaylakaarikorkeus := oy;      end;  end else result := false;end;procedure TCurveParam.SetLowerLeftCurveWidth( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := vasenalakaarileveys;ok := true;muutos := true;  if (kupla.KeepBubbleForm) then    muutos := kupla.skaalaax( Value/vara )  else vasenalakaarileveys := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else    begin    if (kupla.KeepBubbleForm) then      kupla.skaalaax( vara/Value )    else vasenalakaarileveys := vara;    kupla.maaritaparametrit;    end;end;procedure TCurveParam.SetUpperLeftCurveWidth( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := vasenylakaarileveys;ok := true;muutos := true;  if (kupla.KeepBubbleForm) then    muutos := kupla.skaalaax( Value/vara )  else vasenylakaarileveys := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else    begin    if (kupla.KeepBubbleForm) then      kupla.skaalaax( vara/Value )    else vasenylakaarileveys := vara;    kupla.maaritaparametrit;    end;end;procedure TCurveParam.SetLowerRightCurveWidth( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := oikeaalakaarileveys;ok := true;muutos := true;  if (kupla.KeepBubbleForm) then    muutos := kupla.skaalaax( Value/vara )  else oikeaalakaarileveys := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else    begin    if (kupla.KeepBubbleForm) then      kupla.skaalaax( vara/Value )    else oikeaalakaarileveys := vara;    kupla.maaritaparametrit;    end;end;procedure TCurveParam.SetUpperRightCurveWidth( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := oikeaylakaarileveys;ok := true;muutos := true;  if (kupla.KeepBubbleForm) then    muutos := kupla.skaalaax( Value/vara )  else oikeaylakaarileveys := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else    begin    if (kupla.KeepBubbleForm) then      kupla.skaalaax( vara/Value )    else oikeaylakaarileveys := vara;    kupla.maaritaparametrit;    end;end;procedure TCurveParam.SetLowerLeftCurveHeight( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := vasenalakaarikorkeus;ok := true;muutos := true;  if (kupla.KeepBubbleForm) then    muutos := kupla.skaalaay( Value/vara )  else vasenalakaarikorkeus := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else    begin    if (kupla.KeepBubbleForm) then      kupla.skaalaay( vara/Value )    else vasenalakaarikorkeus := vara;    kupla.maaritaparametrit;    end;end;procedure TCurveParam.SetUpperLeftCurveHeight( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := vasenylakaarikorkeus;ok := true;muutos := true;  if (kupla.KeepBubbleForm) then    muutos := kupla.skaalaay( Value/vara )  else vasenylakaarikorkeus := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else    begin    if (kupla.KeepBubbleForm) then      kupla.skaalaay( vara/Value )    else vasenylakaarikorkeus := vara;    kupla.maaritaparametrit;    end;end;procedure TCurveParam.SetLowerRightCurveHeight( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := oikeaalakaarikorkeus;ok := true;muutos := true;  if (kupla.KeepBubbleForm) then    muutos := kupla.skaalaay( Value/vara )  else oikeaalakaarikorkeus := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else    begin    if (kupla.KeepBubbleForm) then      kupla.skaalaay( Value/vara )    else oikeaalakaarikorkeus := vara;    kupla.maaritaparametrit;    end;end;procedure TCurveParam.SetUpperRightCurveHeight( Value : integer );var ok,muutos : Boolean;    vara : integer;begin  vara := oikeaylakaarikorkeus;ok := true;muutos := true;  if (kupla.KeepBubbleForm) then    muutos := kupla.skaalaay( Value/vara )  else oikeaylakaarikorkeus := Value;  if muutos then ok := kupla.maar_ja_tarkistaparametrit;  if ok then kupla.Invalidate else    begin    if (kupla.KeepBubbleForm) then      kupla.skaalaay( Value/vara )    else oikeaylakaarikorkeus := vara;    kupla.maaritaparametrit;    end;end;{ TKupla }procedure TKupla.tekstimuutettu( Sender : TObject );begin  InValidate;end;constructor TKupla.Create( AOwner : TComponent );begin  inherited Create( AOwner );  teksti := TStringList.Create;  curveparam := TCurveparam.Create;curveparam.kupla := self;  mouthparam := TMouthparam.Create;mouthparam.kupla := self;  kuva := TPicture.Create;  curveparam.SetBeginValues;  mouthparam.SetBeginValues;  alku := true;  teksti.OnChanging := nil;  teksti.OnChange := tekstimuutettu;  fontti := TFont.Create;  fontti.OnChange := tekstimuutettu;  korkeus := 100;leveys := 75;leftk := 15;topk := 0;  textpaikkax := 20;textpaikkay := 20;  textleveys := 40;textkorkeus := 50;  kuvapaikkax:= 20;kuvapaikkay := 20;  kuvaleveys := 40;kuvakorkeus := 50;  onteksti := true;onkuva := false;  height := 100;width := 100;  pidakuplamuoto := true;  alku := false;  rivivali := 5;  viivanpaksuus := 3;  onteksti := true;  onvaritekstialue := false;  tekstialuevari := clBlue;  varitekstialuealkusarake := 1;  varitekstialuealkurivi := 0;  varitekstialueloppusarake := 1;  varitekstialueloppurivi := 0;  tayttovari := ClWhite;reunusvari := ClBlack;end;destructor TKupla.Destroy;begin  inherited Destroy;  fontti.destroy;  teksti.destroy;  curveparam.destroy;  mouthparam.destroy;  kuva.destroy;end;{ piirto- ja tarkistusohjelmien idea on se, ett… siin… vaiheessa, kun  kuplan parametreja asetetaan tai muutetaan, ne tarkistetaan ja  jos ne ovat oikeita asetetaan my˚s piirtoparametrit olion  sis…lle mahdollisimman helpoiksi piirt…mist… varten, jotta se  sujuisi nopeasti. Parametreja asetettaessa talletetaan ensin  muutettavan parametrin vanha arvo apumuuttujaan, sijoitetaan  sitten parametrin mahdollinen uusi arvo olion sis…lle vastaavaan  parametrimuuttujaan, ajetaan ensiksi maar_ja_tarkistaparametrit,  joka asettaa piirtoparametrit paikalleen ja antaa tuloksen  siit…, onko parametrit kunnossa vai ei. Jos parametrit ei ole  kunnossa, siirret……n muutettu parametrin arvo apumuuttujasta  olion parametrimuuttujaan ja ajetaan maaritaparametrit, joka  asettaa piirtoparametrit ennalleen. Lopuksi, jos muutettu  parametri on olio, poistetaan apumuuttujan esiintym… muistista. }{ Parametrien m……ritys ohjelmia }function xellipsipiste( kpx, kpy, xsade, ysade, y, neljannes : integer )         : integer;var ytoe : integer; { y ellipsin suhteen }begin  ytoe := y-kpy;  case neljannes of    1 : result := kpx + round(xsade*sqrt( 1-(ytoe/ysade)*(ytoe/ysade) ));    2 : result := kpx - round(xsade*sqrt( 1-(ytoe/ysade)*(ytoe/ysade) ));    3 : result := kpx - round(xsade*sqrt( 1-(ytoe/ysade)*(ytoe/ysade) ));    4 : result := kpx + round(xsade*sqrt( 1-(ytoe/ysade)*(ytoe/ysade) ));  end;end;function yellipsipiste( kpx, kpy, xsade, ysade, x, neljannes : integer )         : integer;var xtoe : integer; { x ellipsin suhteen }begin  xtoe := x-kpx;  case neljannes of    1 : result := kpy - round(ysade*sqrt( 1-(xtoe/xsade)*(xtoe/xsade) ));    2 : result := kpy - round(ysade*sqrt( 1-(xtoe/xsade)*(xtoe/xsade) ));    3 : result := kpy + round(ysade*sqrt( 1-(xtoe/xsade)*(xtoe/xsade) ));    4 : result := kpy + round(ysade*sqrt( 1-(xtoe/xsade)*(xtoe/xsade) ));  end;end;procedure Tkupla.maaritavasensuuoskaaret;{ Selitys maaritakaaret -ohjelmassa. }begin  with MouthParam,CurveParam do begin    piste1x := leftk; piste1y := topk+MouthPlace;    piste2x := leftk; piste2y := topk+MouthPlace+MouthPlaceWidth;    osakaarenpala1 := 6; osakaarenpala2 := 6;    if ( MouthPlace<UpperLeftCurveHeight ) then osakaarenpala1:=2;    if ( MouthPlace+MouthPlaceWidth < UpperLeftCurveHeight ) then      osakaarenpala2:=2;    if ( MouthPlace>korkeus-LowerLeftCurveHeight ) then osakaarenpala1 := 3;    if ( MouthPlace+MouthPlaceWidth > korkeus-LowerLeftCurveHeight ) then      osakaarenpala2 := 3;    if (osakaarenpala1=2) then      piste1x := xellipsipiste(        leftk+UpperLeftCurveWidth, topk+UpperLeftCurveHeight,        UpperLeftCurveWidth, UpperLeftCurveHeight,        piste1y , 2 );    if (osakaarenpala2=2) then      piste2x := xellipsipiste(        leftk+UpperLeftCurveWidth, topk+UpperLeftCurveHeight,        UpperLeftCurveWidth, UpperLeftCurveHeight,        piste2y , 2 );    if (osakaarenpala1=3) then      piste1x := xellipsipiste(        leftk+LowerLeftCurveWidth, topk+korkeus-LowerLeftCurveHeight,        LowerLeftCurveWidth, LowerLeftCurveHeight,        piste1y , 3 );    if (osakaarenpala2=3) then      piste2x := xellipsipiste(        leftk+LowerLeftCurveWidth, topk+korkeus-LowerLeftCurveHeight,        LowerLeftCurveWidth, LowerLeftCurveHeight,        piste2y , 3 );  end;end;procedure Tkupla.maaritaoikeasuuoskaaret;{ Selitys maaritakaaret -ohjelmassa. }begin  with MouthParam,CurveParam do begin    piste1x := leftk+leveys; piste1y := topk+MouthPlace+MouthPlaceWidth;    piste2x := leftk+leveys; piste2y := topk+MouthPlace;    osakaarenpala1 := 8; osakaarenpala2 := 8;    if ( MouthPlace<UpperRightCurveHeight ) then osakaarenpala2:=1;    if ( MouthPlace+MouthPlaceWidth < UpperRightCurveHeight ) then      osakaarenpala1 := 1;    if ( MouthPlace > korkeus-LowerRightCurveHeight ) then osakaarenpala2 := 4;    if ( MouthPlace+MouthPlaceWidth > korkeus-LowerRightCurveHeight ) then      osakaarenpala2 := 1;    if (osakaarenpala1=1) then      piste1x := xellipsipiste(        leftk+leveys-UpperRightCurveWidth, topk+UpperRightCurveHeight,        UpperRightCurveWidth, UpperRightCurveHeight,        piste1y , 1 );    if (osakaarenpala2=1) then      piste2x := xellipsipiste(        leftk+leveys-UpperRightCurveWidth, topk+UpperRightCurveHeight,        UpperRightCurveWidth, UpperRightCurveHeight,        piste2y , 1 );    if (osakaarenpala1=4) then      piste1x := xellipsipiste(        leftk+leveys-LowerRightCurveWidth, topk+korkeus-LowerRightCurveHeight,        LowerRightCurveWidth, LowerRightCurveHeight,        piste1y , 4 );    if (osakaarenpala2=4) then      piste2x := xellipsipiste(        leftk+leveys-LowerRightCurveWidth, topk+korkeus-LowerRightCurveHeight,        LowerRightCurveWidth, LowerRightCurveHeight,        piste2y , 4 );  end;end;procedure Tkupla.maaritaylasuuoskaaret;{ Selitys maaritakaaret -ohjelmassa. }begin  with MouthParam,CurveParam do begin    piste1x := leftk+MouthPlace+MouthPlaceWidth;piste1y := topk;    piste2x := leftk+MouthPlace;                piste2y := topk;    osakaarenpala1 := 5; osakaarenpala2 := 5;    if ( MouthPlace<UpperLeftCurveWidth ) then osakaarenpala2:=2;    if ( MouthPlace+MouthPlaceWidth < UpperLeftCurveWidth ) then      osakaarenpala1 := 2;    if ( MouthPlace > leveys-UpperRightCurveWidth ) then osakaarenpala2 := 1;    if ( MouthPlace+MouthPlaceWidth > leveys-UpperRightCurveWidth ) then      osakaarenpala1 := 1;    if (osakaarenpala1=2) then      piste1y := yellipsipiste(        leftk+UpperLeftCurveWidth, topk+UpperLeftCurveHeight,        UpperLeftCurveWidth, UpperLeftCurveHeight,        piste1x , 2 );    if (osakaarenpala2=2) then      piste2y := yellipsipiste(        leftk+UpperLeftCurveWidth, topk+UpperLeftCurveHeight,        UpperLeftCurveWidth, UpperLeftCurveHeight,        piste2x , 2 );    if (osakaarenpala1=1) then      piste1y := yellipsipiste(        leftk+leveys-UpperRightCurveWidth, topk+UpperRightCurveHeight,        UpperRightCurveWidth, UpperRightCurveHeight,        piste1x , 1 );    if (osakaarenpala2=1) then      piste2y := yellipsipiste(        leftk+leveys-UpperRightCurveWidth, topk+UpperRightCurveHeight,        UpperRightCurveWidth, UpperRightCurveHeight,        piste2x , 1 );  end;end;procedure Tkupla.maaritaalasuuoskaaret;{ Selitys maaritakaaret -ohjelmassa. }begin  with MouthParam,CurveParam do begin    piste1x := leftk+MouthPlace;                 piste1y := topk+korkeus;    piste2x := leftk+MouthPlace+MouthPlaceWidth; piste2y := topk+korkeus;    osakaarenpala1 := 7;osakaarenpala2 := 7;    if ( MouthPlace<LowerLeftCurveWidth ) then  osakaarenpala1:=3;    if ( MouthPlace+MouthPlaceWidth < LowerLeftCurveWidth ) then      osakaarenpala2:=3;    if ( MouthPlace > leveys-LowerRightCurveWidth ) then osakaarenpala1 := 4;    if ( MouthPlace+MouthPlaceWidth > leveys-LowerRightCurveWidth ) then      osakaarenpala2 := 4;    if (osakaarenpala1=3) then      piste1y := yellipsipiste(        leftk+LowerLeftCurveWidth, topk+korkeus-LowerLeftCurveHeight,        LowerLeftCurveWidth, LowerLeftCurveHeight,        piste1x , 3 );    if (osakaarenpala2=3) then      piste2y := yellipsipiste(        leftk+UpperLeftCurveWidth, topk+korkeus-LowerLeftCurveHeight,        LowerLeftCurveWidth, LowerLeftCurveHeight,        piste2x , 3 );    if (osakaarenpala1=4) then      piste1y := yellipsipiste(        leftk+leveys-LowerRightCurveWidth, topk+korkeus-LowerRightCurveHeight,        LowerRightCurveWidth, LowerRightCurveHeight,        piste1x , 4 );    if (osakaarenpala2=4) then      piste2y := yellipsipiste(        leftk+leveys-LowerRightCurveWidth, topk+korkeus-LowerRightCurveHeight,        LowerRightCurveWidth, LowerRightCurveHeight,        piste2x , 4 );  end;end;procedure Tkupla.maaritakaaret;begin  {    Proseduuri toteutetaan, kun puhekuplan parametria muutetaan.    Muuttujan osakaarenpala1,osakaarenpala2,piste1x,piste1y,    piste2x,piste2y sijoitetaan olion sis……n, josta ne on    helposti noudettavissa.    Selvitet……n, mihin osaan puhekuplasta suuosan liitospisteet osuvat.    Liitospisteiden koordinaatit talletetaan pisteisiin (piste1x,piste1y)    ja (piste2x,piste2y) vastap…iv……n menev…ss… kiertoj…rjestyksess…    siten, ett… (piste2x,piste2y) tulee t…ss… kiertoj…rjestyksess…    samalla puhekuplan laidalla pisteen (piste1x,piste1y) per…ss….    Pistett… (piste1x,piste1y) laitetaan vastaamaan muuttuja    osakaarenpala1 ja pistett… (piste2x,piste2y) muuttuja    osakaarenpala2 siten, ett… niihin tulee se nurkka tai laita, johon    puhekuplan suuosan liitoskohta osuu. Liitoskohdan katsotaan t…ss…    osuvan laidalle, jos se ei osu nurkkaan.    Nurkka m……ritet……n siten, ett…    1 vastaa oikeata yl…nurkkaa, 2 vasenta yl…nurkkaa,    3 vasenta alanurkkaa ja 4 oikeata alanurkkaa, ts. matemaattisten    nelj…nnesten mukaan vastap…iv……n.    Laita m……ritet……n taas siten, ett…    5 vastaa yl…laitaa, 6 vasenta laitaa, 7 alalaitaa ja 8 oikeata laitaa.  }  case MouthParam.MouthPartDirection of   pleft  : maaritavasensuuoskaaret;   pright : maaritaoikeasuuoskaaret;   pup    : maaritaylasuuoskaaret;   pdown  : maaritaalasuuoskaaret;  end;end;procedure Tkupla.maaritareunat;{ M……ritt…… parametrit leftk ja topk sek… leveys ja korkeus, jotka kertovat  kuplan runko-osan sijoituksen Canvakselle. My˚s viivanpaksuus tulee  ottaa huomioon, jotta viivat n…kyisiv…t Canvaksella koko paksuudellaan. }var erotus : integer;    alkuvaje,kokovaje : integer;    { alku- ja kokovajeet ovat viivanpaksuudesta ja n…kyvyydest…      johtuvat vaje-parametrit. }begin  with mouthparam Do begin  alkuvaje := 1+round(viivanpaksuus/2);kokovaje := 2+viivanpaksuus;  case MouthPartDirection of    pup,pdown :    begin                     if (MouthPartDirection=pup) then begin                       topk := -MouthOutY+alkuvaje;                       korkeus := height-topk-kokovaje;                     end else begin                       topk := alkuvaje;korkeus := height-MouthOutY-kokovaje;                     end;                     leftk := alkuvaje;                     if (MouthDirection=pleft) and                        (MouthPlace+MouthOutX<0) then                       leftk := -MouthPlace-MouthOutX+alkuvaje;                     leveys := width-leftk-kokovaje;                     if (MouthDirection=pright) and                        (MouthPlace+MouthOutX>width) then                        begin                        erotus := width-MouthPlace-MouthOutX;                        width := MouthPlace+MouthOutX;                        leveys := width-erotus-kokovaje;                        end;                   end;    pleft,pright : begin                      if (MouthPartDirection=pleft) then begin                       leftk := -MouthOutX+alkuvaje;                       leveys := width-leftk-kokovaje;                     end else begin                       leftk := alkuvaje;leveys := width-MouthOutX-kokovaje;                     end;                     topk := alkuvaje;                     if (MouthDirection=pup) and                       (MouthPlace+MouthOutY<0) then                       topk := -MouthPlace-MouthOutY+alkuvaje;                     korkeus := height-topk-kokovaje;                     if (MouthDirection=pdown) and                       (MouthPlace+MouthOutY>height) then                       begin                       erotus := height-MouthPlace-MouthOutY;                       height := MouthPlace+MouthOutY;                       korkeus := height-erotus-kokovaje;                       end;                   end;  end;  end;end;{ Parametrien tarkistusohjelmia }function Tkupla.tarkistasuuaukko : Boolean;{ Tarkistaa, ett… kuplan suuosalle tuleva aukko on kuplan reunalla. }begin  result := true;  with MouthParam Do begin    case Mouthparam.MouthPartDirection of      pleft, pright : if ( ( MouthPlace<0 ) or                           ( MouthPlace+MouthPlaceWidth>korkeus ) ) then                           result := false;      pup, pdown    : if ( ( MouthPlace<0 ) or                           ( MouthPlace+MouthPlaceWidth>leveys ) ) then                           result := false;    end;  end;end;function Tkupla.tarkistakaaret : Boolean;{ Tarkistaa, ett… kuplan reunalle m……ritellyt kaaret eiv…t leikkaa  toisiaan, eiv…tk… mene yli kuplan leveyden tai korkeuden. }begin  result := true;  with curveparam Do begin  if ( UpperLeftCurveWidth+UpperRightCurveWidth >       leveys )  then result := false;  if ( LowerLeftCurveWidth+LowerRightCurveWidth >       leveys )  then result := false;  if ( UpperLeftCurveHeight+LowerLeftCurveHeight >       korkeus ) then result := false;  if (UpperRightCurveHeight+LowerRightCurveHeight >       korkeus ) then result := false;  end;end;procedure Tkupla.laskesuhtparam( var spiste1x,spiste1y,spiste2x,spiste2y :  integer );begin  with mouthparam Do begin  case MouthPartDirection of    pleft,pright : begin                   spiste1x := piste1x-leftk;                   spiste1y := piste1y-topk-MouthPlace;                   spiste2x := piste2x-leftk;                   spiste2y := piste2y-topk-MouthPlace;                   end;    pup,pdown    : begin                   spiste1x := piste1x-leftk-MouthPlace;                   spiste1y := piste1y-topk;                   spiste2x := piste2x-leftk-MouthPlace;                   spiste2y := piste2y-topk;                   end;  end;  if (MouthPartDirection=pright) then    begin    spiste1x := spiste1x-leveys;spiste2x := spiste2x-leveys;    end;  if (MouthPartDirection=pdown) then    begin    spiste1y := spiste1y-korkeus;spiste2y := spiste2y-korkeus;    end;  if (MouthPartDirection=pright) or (MouthPartDirection=pup) then    begin vaihda(spiste1x,spiste2x);vaihda(spiste1y,spiste2y); end;  end;end;procedure Tkupla.haeparam( var p,np,merkki : integer ; x : Boolean );beginwith Mouthparam Do  case MouthDirection of    pleft  : if x then       begin p:=MouthSideFormPx;   np:=NotMouthSideFormPx;merkki :=  1;end    else       begin p:=MouthSideFormPy;   np:=NotMouthSideFormPy;end;    pright : if x then       begin p:=NotMouthSideFormPx;np:=MouthSideFormPx;   merkki :=  -1;end    else       begin p:=NotMouthSideFormPy;np:=MouthSideFormPy;   end;    pup    : if x then       begin p:=MouthSideFormPx;   np:=NotMouthSideFormPx;end    else       begin p:=MouthSideFormPy;   np:=NotMouthSideFormPy;merkki :=  1;end;    pdown : if x then       begin p:=NotMouthSideFormPx;np:=MouthSideFormPx;   end    else       begin p:=NotMouthSideFormPy;np:=MouthSideFormPy;   merkki := -1;end;  end;end;function testi1( pmerkki,karki,p,np,sp1,sp2 : integer ): Boolean;begin  result := true;  if ( pmerkki*(karki-p)  >=0 ) then result := false;  if ( pmerkki*(p-sp1)   >=0 ) then result := false;  if ( pmerkki*(karki-np) >=0 ) then result := false;  if ( pmerkki*(np-sp2)  >=0 ) then result := false;end;function testi2( pmerkki,merkki,karki,erotus,p,np,sp1,sp2 : integer )  : Boolean;begin  result := true;  if ( sp1 >= p  ) then result := false;  if ( np >= sp2 ) then result := false;  if ( p > np ) then result := false;  if ( pmerkki*erotus > 0 ) then result := false;  if ( merkki*(karki-p)  >= 0 ) then result := false;  if ( merkki*(karki-np) >= 0 ) then result := false;end;function Tkupla.tarkistasuuosa : Boolean;var merkki,pmerkki,p,np : integer;    spiste1x,spiste1y,spiste2x,spiste2y : integer;begin  { M……ritet……n testiparametri pmerkki }  result := true;  case mouthparam.MouthPartDirection of    pleft,pup : pmerkki :=1 ;    pright, pdown : pmerkki := -1;  end;  laskesuhtparam( spiste1x, spiste1y, spiste2x, spiste2y );  with mouthparam Do begin  case MouthPartDirection of    pleft,pright : begin                   haeparam( p,np,merkki,true );                   result := testi1( pmerkki,MouthOutX,p,np,                                     spiste1x,spiste2x );                   if result then                     begin                     haeparam( p,np,merkki,false );                     result := testi2( pmerkki,merkki,MouthOutY,                       NotMouthSideFormPx-MouthSideFormPx,p,np,                                       spiste1y,spiste2y );                     end;                   end;    pup,pdown    : begin                   haeparam( p,np,merkki,true );                   result := testi2( pmerkki,merkki,MouthOutX,                     NotMouthSideFormPy-MouthSideFormPy,p,np,                       spiste1x,spiste2x );                   if result then                     begin                     haeparam( p,np,merkki,false );                     result := testi1( pmerkki,MouthOutY,p,np,                                       spiste1y,spiste2y );                     end;                   end;  end;  end;end;function Tkupla.tarkistasuorakaide( rx,ry,rleveys,rkorkeus : integer )  : Boolean;{ Ohjelma tarkistaa, onko se suorakulmio, johon teksti tai kuva sijoitetaan,  kuplan reunuksen sis…ll…, ts. tarkistetaan t…m…n suorakulmion  nelj… nurkkaa. }var vastyep : integer; { tutkittavaa nurkkaa vastaava ellipsin                         kysytt…v… koordinaatti. }begin  result := true;  with curveparam Do begin  { vasen yl…nurkka }  vastyep := topk;  if (rx < UpperLeftCurveWidth) then    vastyep := yellipsipiste( leftk+UpperLeftCurveWidth,      topk+UpperLeftCurveHeight, UpperLeftCurveWidth,      UpperLeftCurveHeight, leftk+rx, 2 );  if ( vastyep >= topk+ry ) then result := false;  { oikea yl…nurkka }  vastyep := topk;  if ( rx+rleveys > leveys-UpperRightCurveWidth ) then    vastyep := yellipsipiste( leftk+leveys-UpperRightCurveWidth,      topk+UpperRightCurveHeight, UpperRightCurveWidth,      UpperRightCurveHeight, leftk+rx+rleveys, 1 );  if ( vastyep >= topk+ry ) then result := false;  { vasen alanurkka }  vastyep := topk+korkeus;  if ( rx < LowerLeftCurveWidth ) then    vastyep := yellipsipiste( leftk+LowerLeftCurveWidth,      topk+korkeus-LowerLeftCurveHeight,      LowerLeftCurveWidth, LowerLeftCurveHeight,      leftk+rx, 3 );  if ( vastyep <= topk+ry+rkorkeus ) then result := false;  { oikea alanurkka }  vastyep := topk+korkeus;  if ( rx+rleveys > leveys-LowerRightCurveWidth ) then    vastyep := yellipsipiste( leftk+leveys-LowerRightCurveWidth,      topk+korkeus-LowerRightCurveHeight,      LowerRightCurveWidth, LowerRightCurveHeight,      leftk+rx+rleveys, 4 );  if ( vastyep <= topk+ry+rkorkeus ) then result := false;  end;end;procedure Tkupla.maaritaparametrit;begin  maaritareunat;  maaritakaaret;end;function Tkupla.maar_ja_tarkistaparametrit : Boolean;{ Ohjelma tarkistaa tilap…isesti muutetuilla puhekuplan arvoilla, ovatko  ne kelvollisia. Jos ovat, se palauttaa true, muutoin false.  Ohjelma ajaa ensin maaritaparametrit ohjelman ja tutkii sitten, onko  kuplan piirt…minen sallituissa rajoissa. }begin  maaritareunat;  result := tarkistasuuaukko;  if result then result := tarkistakaaret;  if result then maaritakaaret;  if result then result := tarkistasuuosa;  if result then result := tarkistasuorakaide( textpaikkax,textpaikkay,                                               textleveys,textkorkeus );  if result then result := tarkistasuorakaide( kuvapaikkax,kuvapaikkay,                                               kuvaleveys,kuvakorkeus );end;{ Piirto-ohjelmia }procedure osaellipsi( Canvas : TCanvas ;kpx,kpy,xpuolisade,ypuolisade,piste1x,piste1y,piste2x,piste2y : integer );{ piirt…… osaellipsin ellipsist…, jonka keskipisteon (kpx,kpy) ja jonka x-puolis…de on xpuolisade jay-puolisade ypuolisade, pisteest… (piste1x,piste1y)pisteeseen (piste2x,piste2y). }var ellipsix1,ellipsiy1,ellipsix2,ellipsiy2 : integer;{ arc-funktion suorakaiteen vasenyl… ja oikea alakulma. }begin  ellipsix1 := kpx-xpuolisade;ellipsix2 := kpx+xpuolisade;  ellipsiy1 := kpy-ypuolisade;ellipsiy2 := kpy+ypuolisade;  Canvas.arc( ellipsix1,ellipsiy1,ellipsix2,ellipsiy2,    piste1x,piste1y,piste2x,piste2y );end;function neljannesellipsi( Canvas : TCanvas ;kpx,kpy,xpuolisade,ypuolisade,neljannes : integer ) : Boolean;{ piirt…… Canvakselle nelj…nnesellipsin siten,ett… se edustaa neljannesta yksikk˚ympyr…st…kuten nelj…nnes yleens… xy-koordinaatistossak…sitet……n: 1=oikeayl…,2=vasenyl…,3=vasenala,4=oikeaala ja ellipsin keskipisteen… on piste(kpx,kpy). Funktio palauttaa arvon true, josneljannes-parametri=1,...,4, muutoin false. }var ellipsix1,ellipsiy1,ellipsix2,ellipsiy2 : integer;{ arc-funktion suorakaiteen vasenyl… ja oikea alakulma. }    piste1x,piste1y,piste2x,piste2y : integer;{ l…ht˚piste ja loppupiste arc-funktiota varten }begin  ellipsix1 := kpx-xpuolisade;ellipsix2 := kpx+xpuolisade;  ellipsiy1 := kpy-ypuolisade;ellipsiy2 := kpy+ypuolisade;  case neljannes of    1 : begin        piste1x := kpx+xpuolisade;        piste1y := kpy;        piste2x := kpx;        piste2y := kpy-ypuolisade;        end;    2 : begin        piste1x := kpx;        piste1y := kpy-ypuolisade;        piste2x := kpx-xpuolisade;        piste2y := kpy;        end;    3 : begin        piste1x := kpx-xpuolisade;        piste1y := kpy;        piste2x := kpx;        piste2y := kpy+ypuolisade;        end;    4 : begin        piste1x := kpx;        piste1y := kpy+ypuolisade;        piste2x := kpx+xpuolisade;        piste2y := kpy;        end;  end;  if (neljannes>=1) and (neljannes<=4) then begin    Canvas.arc( ellipsix1,ellipsiy1,ellipsix2,ellipsiy2,      piste1x,piste1y,piste2x,piste2y );    result := true;  end else result := false;end;procedure Tkupla.piirraosakaaret1;begin  with Curveparam Do begin    if ((osakaarenpala1=4) or (osakaarenpala1=8)) and        (osakaarenpala2=1) then       osaellipsi( Canvas,        leftk+leveys-UpperRightCurveWidth, topk+UpperRightCurveHeight,        UpperRightCurveWidth, UpperRightCurveHeight,        piste2x, piste2y,         leftk+leveys-UpperRightCurveWidth, topk );    if ( (osakaarenpala1=1) and (osakaarenpala2=1) ) then      begin       osaellipsi( Canvas,       leftk+leveys-UpperRightCurveWidth, topk+UpperRightCurveHeight,       UpperRightCurveWidth, UpperRightCurveHeight,       leftk+leveys, topk+UpperRightCurveHeight,       piste1x, piste1y );      osaellipsi( Canvas,       leftk+leveys-UpperRightCurveWidth, topk+UpperRightCurveHeight,       UpperRightCurveWidth, UpperRightCurveHeight,       piste2x, piste2y,       leftk+leveys-UpperRightCurveWidth, topk );      end;    if  (osakaarenpala1=1) and       ((osakaarenpala2=5) or (osakaarenpala2=2)) then      osaellipsi( Canvas,        leftk+leveys-UpperRightCurveWidth, topk+UpperRightCurveHeight,        UpperRightCurveWidth, UpperRightCurveHeight,        leftk+leveys, topk+UpperRightCurveHeight,         piste1x, piste1y );  end;end;procedure Tkupla.piirraosakaaret2;begin  with Curveparam Do begin  if ((osakaarenpala1=1) or (osakaarenpala1=5)) and      (osakaarenpala2=2) then     osaellipsi( Canvas,      leftk+UpperLeftCurveWidth, topk+UpperLeftCurveHeight,       UpperLeftCurveWidth, UpperLeftCurveHeight,      piste2x, piste2y,      leftk, topk+UpperLeftCurveHeight );  if ( (osakaarenpala1=2) and (osakaarenpala2=2) ) then     begin     osaellipsi( Canvas,      leftk+UpperLeftCurveWidth, topk+UpperLeftCurveHeight,      UpperLeftCurveWidth, UpperLeftCurveHeight,      leftk+UpperLeftCurveWidth, topk,      piste1x, piste1y );     osaellipsi( Canvas,      leftk+UpperLeftCurveWidth, topk+UpperLeftCurveHeight,       UpperLeftCurveWidth, UpperLeftCurveHeight,       piste2x, piste2y,      leftk, topk+UpperLeftCurveHeight );     end;  if  (osakaarenpala1=2) and      ((osakaarenpala2=6) or (osakaarenpala2=3)) then     osaellipsi( Canvas,      leftk+UpperLeftCurveWidth, topk+UpperLeftCurveHeight,       UpperLeftCurveWidth, UpperLeftCurveHeight,      leftk+UpperLeftCurveWidth, topk,      piste1x, piste1y );  end;end;procedure Tkupla.piirraosakaaret3;begin  with Curveparam Do begin  if ((osakaarenpala1=2) or (osakaarenpala1=6)) and      (osakaarenpala2=3) then     osaellipsi( Canvas,       leftk+LowerLeftCurveWidth, topk+korkeus-LowerLeftCurveHeight,       LowerLeftCurveWidth, LowerLeftCurveHeight,       piste2x, piste2y,       leftk+LowerLeftCurveWidth, topk+korkeus );  if ( (osakaarenpala1=3) and (osakaarenpala2=3) ) then     begin     osaellipsi( Canvas,       leftk+LowerLeftCurveWidth, topk+korkeus-LowerLeftCurveHeight,       LowerLeftCurveWidth, LowerLeftCurveHeight,       leftk, topk+korkeus-LowerLeftCurveHeight,       piste1x, piste1y );     osaellipsi( Canvas,       leftk+LowerLeftCurveWidth, topk+korkeus-LowerLeftCurveHeight,       LowerLeftCurveWidth, LowerLeftCurveHeight,       piste2x, piste2y,       leftk+LowerLeftCurveWidth, topk+korkeus );     end;  if  (osakaarenpala1=3) and     ((osakaarenpala2=7) or (osakaarenpala2=4)) then     osaellipsi( Canvas,       leftk+LowerLeftCurveWidth, topk+korkeus-LowerLeftCurveHeight,       LowerLeftCurveWidth, LowerLeftCurveHeight,       leftk, topk+korkeus-LowerLeftCurveHeight,       piste1x, piste1y );  end;end;procedure Tkupla.piirraosakaaret4;begin  with Curveparam Do begin  if ((osakaarenpala1=3) or (osakaarenpala1=7)) and      (osakaarenpala2=4) then     osaellipsi( Canvas,       leftk+leveys-LowerRightCurveWidth, topk+korkeus-LowerRightCurveHeight,       LowerRightCurveWidth, LowerRightCurveHeight,       piste2x, piste2y,       leftk+leveys, topk+korkeus-LowerRightCurveHeight );  if ( (osakaarenpala1=4) and (osakaarenpala2=4) ) then     begin     osaellipsi( Canvas,       leftk+leveys-LowerRightCurveWidth, topk+korkeus-LowerRightCurveHeight,       LowerRightCurveWidth, LowerRightCurveHeight,       leftk+leveys-LowerRightCurveWidth, topk+korkeus,       piste1x, piste1y );     osaellipsi( Canvas,       leftk+leveys-LowerRightCurveWidth, topk+korkeus-LowerRightCurveHeight,       LowerRightCurveWidth, LowerRightCurveHeight,       piste2x, piste2y,       leftk+leveys, topk+korkeus-LowerRightCurveHeight );     end;  if  (osakaarenpala1=4) and     ((osakaarenpala2=8) or (osakaarenpala2=1)) then     osaellipsi( Canvas,       leftk+leveys-LowerRightCurveWidth, topk+korkeus-LowerRightCurveHeight,       LowerRightCurveWidth, LowerRightCurveHeight,       leftk+leveys-LowerRightCurveWidth, topk+korkeus,       piste1x, piste1y );  end;end;procedure Tkupla.piirrakaaret;begin  with Curveparam Do begin  if (osakaarenpala1=1) or (osakaarenpala2=1) then    piirraosakaaret1  else { t…ysikaari1 }    neljannesellipsi( Canvas,    leftk+leveys-UpperRightCurveWidth,    topk+UpperRightCurveHeight,    UpperRightCurveWidth,UpperRightCurveHeight, 1 );  if (osakaarenpala1=2) or (osakaarenpala2=2) then    piirraosakaaret2  else { t…ysikaari2 }    neljannesellipsi( Canvas,    leftk+UpperLeftCurveWidth,topk+UpperLeftCurveHeight,    UpperLeftCurveWidth,UpperLeftCurveHeight, 2 );  if (osakaarenpala1=3) or (osakaarenpala2=3) then    piirraosakaaret3  else { t…ysikaari3 }    neljannesellipsi( Canvas, leftk+LowerLeftCurveWidth,    topk+korkeus-LowerLeftCurveHeight,    LowerLeftCurveWidth,LowerLeftCurveHeight, 3 );  if (osakaarenpala1=4) or (osakaarenpala2=4) then    piirraosakaaret4  else { t…ysikaari4 }    neljannesellipsi( Canvas, leftk+leveys-LowerRightCurveWidth,    topk+korkeus-LowerRightCurveHeight,    LowerRightCurveWidth,LowerRightCurveHeight, 4 );  end;end;procedure Tkupla.piirraosaviivat;var reuna : integer; { piirrett…vien viivojen kiinte… koordinaatti }    vastalku, vastloppu : integer; { piirrett…v…n viivan p…iss… olevien      kaarien alku- ja loppukoordinaatit }begin  with Canvas,mouthparam,curveparam Do begin    case MouthPartDirection of      pup,pdown :        begin        if (MouthPartDirection=pup) then begin          reuna := topk;          vastalku := UpperLeftCurveWidth;          vastloppu := leftk+leveys-UpperRightCurveWidth;        end else begin          reuna := topk+korkeus;          vastalku := LowerLeftCurveWidth;          vastloppu := leftk+leveys-LowerRightCurveWidth;        end;        if (MouthPlace+MouthPlaceWidth <= vastalku) or           (leftk+MouthPlace >= vastloppu) then begin          MoveTo(leftk+vastalku,reuna);          LineTo(vastloppu,reuna); { 1 & 6 }        end;        if (MouthPlace>vastalku) and           (leftk+MouthPlace<vastloppu) then begin          Moveto(leftk+vastalku,reuna);          LineTo(leftk+MouthPlace,reuna);          { 4 & 5, alkuviiva }        end;        if ( leftk+MouthPlace+MouthPlaceWidth<=vastloppu ) and           ( MouthPlace+MouthPlaceWidth>vastalku ) then begin           Moveto(leftk+MouthPlace+MouthPlaceWidth,reuna);           LineTo(vastloppu,reuna);           { 2 & 4, loppuviiva }        end;        end;      pleft,pright :        begin        if (MouthPartDirection=pleft) then begin          reuna := leftk;          vastalku := UpperLeftCurveHeight;          vastloppu := topk+korkeus-LowerLeftCurveHeight;        end else begin          reuna := leftk+leveys;          vastalku := UpperRightCurveHeight;          vastloppu := topk+korkeus-LowerRightCurveHeight;        end;        if (MouthPlace+MouthPlaceWidth<=vastalku) or           (topk+MouthPlace >= vastloppu) then begin          MoveTo(reuna,topk+vastalku);          LineTo(vastloppu,reuna); { 1 & 6 }        end;        if (MouthPlace>vastalku) and           (topk+MouthPlace<vastloppu) then begin          Moveto(reuna,topk+vastalku);          LineTo(reuna,topk+MouthPlace);          { 4 & 5, alkuviiva }        end;        if ( leftk+MouthPlace+MouthPlaceWidth <= vastloppu ) and           ( MouthPlace+MouthPlaceWidth>vastalku ) then begin           Moveto(reuna,topk+MouthPlace+MouthPlaceWidth);           LineTo(reuna,vastloppu);           { 2 & 4, loppuviiva }        end;        end;    end;  end;end;procedure Tkupla.piirrataydetviivat;begin  with Canvas,mouthparam,curveparam Do begin    if not (MouthPartDirection=pleft) then begin      MoveTo(leftk,topk+UpperLeftCurveHeight);      LineTo(leftk,topk+korkeus-LowerLeftCurveHeight);    end;    if not (MouthPartDirection=pright) then begin      MoveTo(leftk+leveys,topk+UpperRightCurveHeight);      LineTo(leftk+leveys,topk+korkeus-LowerRightCurveHeight);    end;    if not (MouthPartDirection=pdown) then begin      MoveTo(leftk+LowerLeftCurveWidth,topk+korkeus);      LineTo(leftk+leveys-LowerRightCurveWidth,topk+korkeus);    end;    if not (MouthPartDirection=pup) then begin      MoveTo(leftk+UpperLeftCurveWidth,topk);      LineTo(leftk+leveys-LowerRightCurveWidth,topk);    end;  end;end;procedure Tkupla.piirraviivat;begin  piirraosaviivat;  piirrataydetviivat;end;procedure Tkupla.piirravasensuuosa;var xsade : integer;begin  with Canvas,mouthparam do begin    if (MouthDirection=pup) then begin      xsade := -MouthSideFormPx+piste1x-leftk;      neljannesellipsi( Canvas, leftk+MouthSideFormPx,        topk+MouthPlace, xsade, MouthSideFormPy, 4 );      xsade := -NotMouthSideFormPx+piste2x-leftk;      neljannesellipsi( Canvas, leftk+NotMouthSideFormPx,        topk+MouthPlace+MouthPlaceWidth, xsade,        MouthPlaceWidth-NotMouthSideFormPy, 1 );      neljannesellipsi( Canvas, leftk+MouthSideFormPx,        topk+MouthPlace+MouthOutY,        MouthSideFormPx-MouthOutX,        MouthSideFormPy-MouthOutY, 3 );      neljannesellipsi( Canvas, leftk+NotMouthSideFormPx,        topk+MouthPlace+MouthOutY,        NotMouthSideFormPx-MouthOutX,        NotMouthSideFormPy-MouthOutY, 3 );    end else begin { MouthDirection=pdown }      xsade := -NotMouthSideFormPx+piste1x-leftk;      neljannesellipsi( Canvas, leftk+NotMouthSideFormPx,        topk+MouthPlace, xsade, NotMouthSideFormPy, 4 );      xsade := -MouthSideFormPx+piste2x-leftk;      neljannesellipsi( Canvas, leftk+MouthSideFormPx,        topk+MouthPlace+MouthPlaceWidth, xsade, MouthPlaceWidth-        MouthSideFormPy, 1 );      neljannesellipsi( Canvas, leftk+MouthSideFormPx,        topk+MouthPlace+MouthOutY,        MouthSideFormPx-MouthOutX,        MouthOutY-MouthSideFormPy, 2 );      neljannesellipsi( Canvas, leftk+NotMouthSideFormPx,        topk+MouthPlace+MouthOutY,        NotMouthSideFormPx-MouthOutX,        MouthOutY-NotMouthSideFormPy, 2 );    end;  end;end;procedure Tkupla.piirraoikeasuuosa;var xsade : integer;begin  with Canvas,mouthparam do begin    if (MouthDirection=pup) then begin      xsade := MouthSideFormPx-piste2x+leftk+leveys;      neljannesellipsi( Canvas, leftk+leveys+MouthSideFormPx,        topk+MouthPlace, xsade, MouthSideFormPy, 3 );      xsade := NotMouthSideFormPx-piste1x+leftk+leveys;      neljannesellipsi( Canvas, leftk+leveys+NotMouthSideFormPx,        topk+MouthPlace+MouthPlaceWidth, xsade,        MouthPlaceWidth-NotMouthSideFormPy, 2 );      neljannesellipsi( Canvas, leftk+leveys+MouthSideFormPx,        topk+MouthPlace+MouthOutY,        MouthOutX-MouthSideFormPx,        MouthSideFormPy-MouthOutY, 4 );      neljannesellipsi( Canvas, leftk+leveys+NotMouthSideFormPx,        topk+MouthPlace+MouthOutY,        MouthOutX-NotMouthSideFormPx,        NotMouthSideFormPy-MouthOutY, 4 );    end else begin { MouthDirection=pdown }      xsade := NotMouthSideFormPx-piste2x+leftk+leveys;      neljannesellipsi( Canvas, leftk+leveys+NotMouthSideFormPx,        topk+MouthPlace,        xsade, NotMouthSideFormPy, 3 );      xsade := MouthSideFormPx-piste1x+leftk+leveys;      neljannesellipsi( Canvas, leftk+leveys+MouthSideFormPx,        topk+MouthPlace+MouthPlaceWidth, xsade,        MouthPlaceWidth-MouthSideFormPy, 2 );      neljannesellipsi( Canvas, leftk+leveys+MouthSideFormPx,        topk+MouthPlace+MouthOutY,        MouthOutX-MouthSideFormPx,        MouthOutY-MouthSideFormPy,1 );      neljannesellipsi( Canvas, leftk+leveys+NotMouthSideFormPx,        topk+MouthPlace+MouthOutY,        MouthOutX-NotMouthSideFormPx,        MouthOutY-NotMouthSideFormPy,        1 );    end;  end;end;procedure Tkupla.piirraylasuuosa;var ysade : integer;begin  with Canvas,mouthparam do begin    if (MouthDirection=pleft) then begin      ysade := -MouthSideFormPy+piste2y-topk;      neljannesellipsi( Canvas, MouthPlace,        topk+MouthSideFormPy, MouthSideFormPx, ysade, 4 );      ysade := -NotMouthSideFormPy+piste1y-topk;      neljannesellipsi( Canvas, MouthPlace+MouthPlaceWidth,         topk+NotMouthSideFormPy,         MouthPlaceWidth-NotMouthSideFormPx, ysade, 3 );      neljannesellipsi( Canvas, MouthPlace+MouthOutX,        topk+MouthSideFormPy,        MouthSideFormPx-MouthOutX,        MouthSideFormPy-MouthOutY, 1 );      neljannesellipsi( Canvas, MouthPlace+MouthOutX,        topk+NotMouthSideFormPy,        NotMouthSideFormPx-MouthOutX,        NotMouthSideFormPy-MouthOutY, 1 );    end else begin { MouthDirection=pright }      ysade := -NotMouthSideFormPy+piste1y-topk;      neljannesellipsi( Canvas, MouthPlace,        topk+NotMouthSideFormPy,        NotMouthSideFormPx, ysade, 4 );      ysade := -MouthSideFormPy+piste2y-topk;      neljannesellipsi( Canvas, MouthPlace+MouthPlaceWidth,         topk+MouthSideFormPy,         MouthPlaceWidth-MouthSideFormPx, ysade, 3 );      neljannesellipsi( Canvas, MouthPlace+MouthOutX,        topk+MouthSideFormPy,        MouthOutX-MouthSideFormPx,        MouthSideFormPy-MouthOutY, 2 );      neljannesellipsi( Canvas, MouthPlace+MouthOutX,        topk+NotMouthSideFormPy,        MouthOutX-NotMouthSideFormPx,        NotMouthSideFormPy-MouthOutY, 2 );    end;  end;end;procedure Tkupla.piirraalasuuosa;var ysade : integer;begin  with Canvas,mouthparam do begin    if (MouthDirection=pleft) then begin      ysade := MouthSideFormPy-piste1y+topk+korkeus;      neljannesellipsi( Canvas, MouthPlace,      topk+korkeus+MouthSideFormPy, MouthSideFormPx,        ysade, 1 );      ysade := NotMouthSideFormPy-piste2y+topk+korkeus;      neljannesellipsi( Canvas, MouthPlace+MouthPlaceWidth,         topk+korkeus+NotMouthSideFormPy,         MouthPlaceWidth-NotMouthSideFormPx, ysade, 2 );      neljannesellipsi( Canvas, MouthPlace+MouthOutX,        topk+korkeus+MouthSideFormPy,        MouthSideFormPx-MouthOutX,        MouthOutY-MouthSideFormPy, 4 );      neljannesellipsi( Canvas, MouthPlace+MouthOutX,        topk+korkeus+NotMouthSideFormPy,        NotMouthSideFormPx-MouthOutX,        MouthOutY-NotMouthSideFormPy, 4 );    end else begin { MouthDirection=pright }      ysade := NotMouthSideFormPy-piste1y+topk+korkeus;      neljannesellipsi( Canvas, MouthPlace,        topk+korkeus+NotMouthSideFormPy,        NotMouthSideFormPx, ysade, 1 );      ysade := MouthSideFormPy-piste2y+topk+korkeus;      neljannesellipsi( Canvas, MouthPlace+MouthPlaceWidth,         topk+korkeus+MouthSideFormPy,         MouthPlaceWidth-MouthSideFormPx, ysade, 2 );      neljannesellipsi( Canvas, MouthPlace+MouthOutX,        topk+korkeus+MouthSideFormPy,        MouthOutX-MouthSideFormPx,        MouthOutY-MouthSideFormPy, 3 );      neljannesellipsi( Canvas, MouthPlace+MouthOutX,        topk+korkeus+NotMouthSideFormPy,        MouthOutX-NotMouthSideFormPx,        MouthOutY-NotMouthSideFormPy, 3 );    end;  end;end;procedure Tkupla.piirrasuuosa;begin  case mouthparam.MouthPartDirection of    pleft  : piirravasensuuosa;    pright : piirraoikeasuuosa;    pup    : piirraylasuuosa;    pdown  : piirraalasuuosa;  end;end;procedure Tkupla.taytasisus;begin  with Canvas,curveparam do begin    Brush.Style := bssolid;    Brush.Color := tayttovari;    FloodFill( leftk+UpperLeftCurveWidth,                    topk+UpperLeftCurveHeight,                    reunusvari, fsBorder );  end;end;function Tkupla.sopivamj( const mj :string ; var muuttui : Boolean ;   var rleveys : integer ) : string;var mjpituus : integer;begin  muuttui := false;  result := concat(mj);  mjpituus := length(result);  rleveys := Canvas.textwidth(result);  while ( rleveys > textleveys ) do begin    muuttui := true;    Dec(mjpituus);SetLength(result,mjpituus);    rleveys := Canvas.textwidth(result);  end;end;procedure Tkupla.piirratekstirivi( xpaikka, ypaikka, rivi : integer ;  mj : string );var tekstileveys : integer;    osamj : string;begin with Canvas Do begin if (rivi<varitekstialuealkurivi) or    (rivi>varitekstialueloppurivi ) or ( not onvaritekstialue ) then   textout(xpaikka,ypaikka,mj) else begin   if (rivi=varitekstialuealkurivi) then begin     osamj := Copy(mj,1,varitekstialuealkusarake-1);     TextOut( xpaikka,ypaikka, osamj );     Font.Color := tekstialuevari;     tekstileveys := Canvas.TextWidth(osamj);     if (varitekstialuealkusarake<=length(mj)) then begin       if (varitekstialueloppurivi=varitekstialuealkurivi) then begin         osamj := Copy(mj,varitekstialuealkusarake,           varitekstialueloppusarake-varitekstialuealkusarake+1 );         TextOut( xpaikka+tekstileveys , ypaikka , osamj );         Font.Color := vari;         tekstileveys := tekstileveys + textwidth(osamj);         if (varitekstialueloppusarake+1<=length(mj)) then begin           osamj := Copy(mj,varitekstialueloppusarake+1, length(mj) );           TextOut( xpaikka+tekstileveys , ypaikka , osamj );         end;       end else begin         osamj := Copy(mj, varitekstialuealkusarake, length(mj) );         TextOut( xpaikka+tekstileveys , ypaikka , osamj );       end;     end;   end;   if (rivi=varitekstialueloppurivi) and      (varitekstialueloppurivi>varitekstialuealkurivi) then begin     osamj := Copy(mj,1,varitekstialueloppusarake-1);     TextOut( xpaikka, ypaikka , osamj );     tekstileveys := textwidth( osamj );     Font.Color := vari;     if (varitekstialueloppusarake<=length(mj)) then begin       osamj := Copy(mj,varitekstialueloppusarake,length(mj) );       TextOut( xpaikka+tekstileveys,ypaikka,osamj );     end;   end; end; end;end;procedure Tkupla.piirrateksti;var korkeus,t : integer;    tulmj : string;    loppu, muuttui : Boolean;    xpaikka : integer;    rleveys : integer;begin  loppu := (teksti.Count=0);t := 0;korkeus := 0;  if (harjaon) then Canvas.Brush.Style := bssolid    else Canvas.Brush.Style := bsclear;  with Canvas Do begin    Font.Assign(fontti);    vari := Font.Color;    while (not loppu) do begin      tulmj := sopivamj( teksti.Strings[t] , muuttui , rleveys );      xpaikka := textpaikkax;      if not muuttui then        case tasaus of          acenter : xpaikka := round((textleveys-rleveys)/2)+textpaikkax;          aright  : xpaikka := textpaikkax+textleveys-rleveys;          aleft   : xpaikka := textpaikkax;        end;      if (korkeus+textheight(teksti.Strings[t])>textkorkeus) then        loppu := true;      if not loppu then        piirratekstirivi(leftk+xpaikka, topk+textpaikkay+korkeus,t,tulmj );      korkeus := korkeus+textheight(teksti.Strings[t])+rivivali;      inc(t);      if (t>teksti.Count-1) then loppu := true;    end;  end;end;procedure Tkupla.Paint;var suorakaide : TRect;begin  if onreuna then begin    Canvas.Pen.Color := reunusvari;    Canvas.Pen.Width := viivanpaksuus;    piirrakaaret;    piirraviivat;    piirrasuuosa;    if (taytetaan) then taytasisus;  end;  suorakaide.Left := leftk+kuvapaikkax;  suorakaide.Top := topk+kuvapaikkay;  suorakaide.Right := leftk+kuvapaikkax+kuvaleveys;  suorakaide.Bottom := topk+kuvapaikkay+kuvakorkeus;  if onkuva then Canvas.Stretchdraw(suorakaide,kuva.Graphic);  if onteksti then piirrateksti;end;procedure TKupla.SetText( const Value : TStringList );begin  teksti.Assign( Value );  InValidate;end;procedure TKupla.SetFont( Value : TFont );begin  fontti.Assign( Value );  InValidate;end;procedure TKupla.SetLineCap( Value : integer );begin  rivivali := Value;  InValidate;end;procedure TKupla.SetTextOn( Value : Boolean );begin  onteksti := Value;end;procedure TKupla.SetTextBeginX( Value : integer );var vara : integer;    ok,muutos : Boolean;begin  vara := textpaikkax;textpaikkax := Value;  ok:= tarkistasuorakaide( textpaikkax,textpaikkay,textleveys,textkorkeus );  if ok then Invalidate else textpaikkax:= vara;end;procedure TKupla.SetTextBeginY( Value : integer );var vara : integer;    ok,muutos : Boolean;begin  vara := textpaikkay;textpaikkay := Value;  ok:= tarkistasuorakaide( textpaikkax,textpaikkay,textleveys,textkorkeus );  if ok then Invalidate else textpaikkay := vara;end;procedure TKupla.SetTextAreaWidth( Value : integer );var vara : integer;    ok,muutos : Boolean;begin  vara := textleveys;textleveys := Value;  ok:= tarkistasuorakaide( textpaikkax,textpaikkay,textleveys,textkorkeus );  if ok then Invalidate else textleveys := vara;end;procedure TKupla.SetTextAreaHeight( Value : integer );var vara : integer;    ok : Boolean;begin  vara := textkorkeus;textkorkeus := Value;  ok:= tarkistasuorakaide( textpaikkax,textpaikkay,textleveys,textkorkeus );  if ok then Invalidate else textkorkeus := vara;end;procedure TKupla.SetAlignment( Value : TAlignment );begin  tasaus := Value;  InValidate;end;function Tkupla.tarkistavaritekstialue : Boolean;var pituus : integer;begin  result := true;  if (teksti.Count>=1) then begin  if (varitekstialuealkurivi<0) or     (varitekstialuealkurivi>teksti.Count-1) then result := false;  if (varitekstialueloppurivi<0) or     (varitekstialueloppurivi>teksti.Count-1) then result := false;  if (varitekstialuealkurivi>varitekstialueloppurivi) then result := false;  pituus := length(teksti.Strings[varitekstialuealkurivi]);  if (varitekstialuealkusarake<=0) or     (varitekstialuealkusarake>pituus) then result := false;  pituus := length(teksti.Strings[varitekstialueloppurivi]);  if (varitekstialueloppusarake<=0) or     (varitekstialueloppusarake>pituus) then result := false;  if (varitekstialuealkurivi=varitekstialueloppurivi) and     (varitekstialuealkusarake>varitekstialueloppusarake) then result := false;  end;   end;procedure TKupla.SetColoredTextAreaOn( Value : Boolean );var ok : Boolean;begin  if (Value=true) then begin    ok := tarkistavaritekstialue;    if ok then onvaritekstialue := true;  end else onvaritekstialue := false;  InValidate;end;procedure Tkupla.SetColoredTextAreaColor( Value : TColor );begin  tekstialuevari := Value;  InValidate;end;procedure TKupla.SetColoredTextAreaBeginRow( Value : integer );var vara : integer;    ok : Boolean;begin  vara := varitekstialuealkurivi;  varitekstialuealkurivi := Value;  ok := tarkistavaritekstialue;  if not ok then varitekstialuealkurivi := vara else InValidate;end;procedure TKupla.SetColoredTextAreaBeginCol( Value : integer );var vara : integer;    ok : Boolean;begin  vara := varitekstialuealkusarake;  varitekstialuealkusarake := Value;  ok := tarkistavaritekstialue;  if not ok then varitekstialuealkusarake := vara else InValidate;end;procedure TKupla.SetColoredTextAreaEndRow( Value : integer );var vara : integer;    ok : Boolean;begin  vara := varitekstialueloppurivi;  varitekstialueloppurivi := Value;  ok := tarkistavaritekstialue;  if not ok then varitekstialueloppurivi := vara else InValidate;end;procedure TKupla.SetColoredTextAreaEndCol( Value : integer );var vara : integer;    ok : Boolean;begin  vara := varitekstialueloppurivi;  varitekstialueloppusarake := Value;  ok := tarkistavaritekstialue;  if not ok then varitekstialueloppurivi := vara else InValidate;end;procedure TKupla.SetPicture( Value : TPicture );begin  kuva.Assign( Value );  InValidate;end;procedure Tkupla.SetPicturex( Value : integer );var vara : integer;    ok : Boolean;begin  vara := kuvapaikkax;  if (Value>0) then    begin    kuvapaikkax := Value;    ok := tarkistasuorakaide( kuvapaikkax, kuvapaikkay,                              kuvaleveys, kuvakorkeus );    if ok then InValidate else kuvapaikkax := vara;  end;end;procedure Tkupla.SetPicturey( Value : integer );var vara : integer;    ok : Boolean;begin  vara := kuvapaikkay;  if (Value>0) then    begin    kuvapaikkay := Value;    ok := tarkistasuorakaide( kuvapaikkax, kuvapaikkay,                              kuvaleveys, kuvakorkeus );    if ok then InValidate else kuvapaikkay := vara;    end;end;procedure Tkupla.SetPictureWidth( Value : integer );var vara : integer;    ok : Boolean;begin  vara := kuvaleveys;  if (Value>0) then    begin    kuvaleveys := Value;    ok := tarkistasuorakaide( kuvapaikkax, kuvapaikkay,                              kuvaleveys, kuvakorkeus );    if ok then InValidate else kuvaleveys := vara;    end;end;procedure Tkupla.SetPictureHeight( Value : integer );var vara : integer;    ok : Boolean;begin  vara := kuvakorkeus;  if (Value>0) then    begin    kuvakorkeus := Value;    ok := tarkistasuorakaide( kuvapaikkax, kuvapaikkay,                              kuvaleveys, kuvakorkeus );    if ok then InValidate else kuvakorkeus := vara;    end;end;procedure Tkupla.SetPictureOn( Value : Boolean );begin  onkuva := Value;  InValidate;end;procedure TKupla.SetBorderOn( Value : Boolean );begin  onreuna := Value;  InValidate;end;procedure TKupla.SetBorderWidth( Value : integer );begin  if (Value>=2) and (Value<=5) then    viivanpaksuus := Value;  InValidate;end;procedure TKupla.SetFillColor( Value : TColor );begin  tayttovari := Value;  InValidate;end;procedure TKupla.SetBorderColor( Value : TColor );begin  reunusvari := Value;  InValidate;end;procedure TKupla.SetBounds(ALeft, ATop, AWidth, AHeight: Integer);var varaleft,varatop,varaleveys,varakorkeus : integer;    kerroin : double;    ok,muutos : Boolean;begin  varaleft := left;varatop := top;  varaleveys := width;varakorkeus := height;  muutos := true;ok := true;  inherited SetBounds(ALeft,ATop,AWidth,AHeight);  if not alku then begin    if (pidakuplamuoto) then begin      muutos := skaalaax(AWidth/varaleveys);      if muutos then muutos := skaalaay(AHeight/varakorkeus);      if not muutos then ok:= false;    end;    if ok then ok := maar_ja_tarkistaparametrit;    if (ok or (not muutos)) then Invalidate else begin      inherited SetBounds(varaleft,varatop,varaleveys,        varakorkeus);      if (pidakuplamuoto) then begin        skaalaax(varaleveys/AWidth);        skaalaay(varakorkeus/AHeight);      end;      maaritaparametrit;    end;  end;end;procedure TKupla.SetMouthParam( Value : TMouthParam );var ok : Boolean;    vara : TMouthParam;begin  vara := TMouthParam.Create;  vara.Assign( mouthparam );  Assign( Value );  mouthparam.kupla := self;  ok := maar_ja_tarkistaparametrit;  if ok then InValidate else    begin    Assign(vara);    maaritaparametrit;    end;  vara.free;end;procedure TKupla.SetCurveParam( Value : TCurveParam );var ok : Boolean;    vara : TCurveParam;begin  vara := TCurveParam.Create;  vara.Assign( curveparam );  Assign( Value );  curveparam.kupla := self;  ok := maar_ja_tarkistaparametrit;  if ok then InValidate else    begin    Assign(vara);    maaritaparametrit;    end;  vara.free;end;function Tkupla.skaalaax( kerroin : double ) : Boolean;var utextleveys,utextpaikkax : integer;begin  result := curveparam.skaalaax( kerroin );end;function Tkupla.skaalaay( kerroin : double ) : Boolean;var utextkorkeus,utextpaikkay : integer;begin  result := curveparam.skaalaay( kerroin );end;procedure TKupla.SetKeepBubbleForm( Value : Boolean );begin  pidakuplamuoto := Value;end;procedure TKupla.SetBrushOn( Value : Boolean );begin  harjaon := Value;  InValidate;end;procedure TKupla.SetFillOn( Value : Boolean );begin  taytetaan := Value;  InValidate;end;{ Register }procedure Register;begin  RegisterComponents('Opetusohjelma',[Tkupla]);end;end.